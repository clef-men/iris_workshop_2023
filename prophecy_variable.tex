\section{Prophecy variables}

\begin{frame}{Prophecy variables}
\textit{The future is ours: prophecy variables in separation logic}.

Jung, Lepigre, Parthasarathy, Rapoport, Timany, Dreyer \& Jacobs (2020).
\vfill
\[
	\begin{array}{c}
			\triple{
				\iTrue
			}{
				\texttt{NewProph}
			}{
				\lambda\ p .\,
				\exists prophs .\,
				\textcolor{blue}{\mathrm{proph}\ p\ \mathit{prophs}}
			}
		\\\\\\
			\inferrule*
				{
					\mathrm{atomic}\ e
				\\\\
					\textcolor{blue}{\mathrm{proph}\ p\ \mathit{prophs}}
				\\\\
					\weakestpre{
						e
					}{
						\begin{array}{l}
								\lambda w .\,
								\forall \mathit{prophs'} .\,
							\\
								\textcolor{red}{\mathit{prophs} = (w, v) :: \mathit{prophs'}} \iSepimp
							\\
								\textcolor{blue}{\mathrm{proph}\ p\ \mathit{prophs'}} \iSepimp
							\\
								\Phi\ w
						\end{array}
					}
				}{
					\weakestpre{
						\texttt{Resolve}\ e\ p\ v
					}{
						\Phi
					}
				}
	\end{array}
\]
\end{frame}

% ---------------------------------------------------------

\begin{frame}[fragile]{Back to \textit{The future is ours} (Jung \etal)}
\begin{Verbatim}[commandchars=\\\{\}]
let rdcss rm rn m1 n1 n2 =
  \textcolor{blue}{let p = NewProph in}
  let descr = ref (rm, m1, n1, n2, p) in
  ...
\end{Verbatim}
\vfill
\begin{Verbatim}[commandchars=\\\{\}]
let complete descr rn =
  let (rm, m1, n1, n2, p) = !descr in
  \textcolor{blue}{let id = NewId in}
  let m = !rm in
  let n_new = if m = m1 then n2 else n1 in
  \textcolor{blue}{Resolve} (CmpXchg rn (inr descr) (inl n_new)) \textcolor{blue}{p id} ;
  ()
\end{Verbatim}
\end{frame}

% ---------------------------------------------------------

\begin{frame}{Prophecy variables with memory}
\[
	\begin{array}{c}
			\triple{
				\iTrue
			}{
				\texttt{NewProph}
			}{
				\lambda\ p .\,
				\exists \textcolor{teal}{\gamma}, \mathit{prophs} .\,
				\textcolor{blue}{\mathrm{proph}\ p\ \textcolor{teal}{\gamma\ []}\ \mathit{prophs}}
			}
		\\\\\\
			\inferrule*
				{
					\mathrm{atomic}\ e
				\\\\
					\textcolor{blue}{\mathrm{proph}\ p\ \textcolor{teal}{\gamma\ \mathit{past}}\ \mathit{prophs}}
				\\\\
					\weakestpre{
						e
					}{
						\begin{array}{l}
								\lambda w .\,
								\forall \mathit{prophs'} .\,
							\\
								\textcolor{red}{\mathit{prophs} = (w, v) :: \mathit{prophs'}} \iSepimp
							\\
								\textcolor{blue}{\mathrm{proph}\ p\ \textcolor{teal}{\gamma\ (\mathit{past} \mdoubleplus [(w, v)])}\ \mathit{prophs'}} \iSepimp
							\\
								\Phi\ w
						\end{array}
					}
				}{
					\weakestpre{
						\texttt{Resolve}\ e\ p\ v
					}{
						\Phi
					}
				}
	\end{array}
\]
\end{frame}

% ---------------------------------------------------------

\begin{frame}{Prophecy variables with memory}
\begin{mathpar}
	\inferrule*[lab=ProphecyLbGet]
		{
			\mathrm{proph}\ p\ \gamma\ \mathit{past}\ \textcolor{blue}{\mathit{prophs}}
		}{
			\mathrm{proph \mathhyphen lb}\ \gamma\ \textcolor{blue}{\mathit{prophs}}
		}
	\\\\
	\inferrule*[lab=ProphecyValid]
		{
			\mathrm{proph}\ p\ \gamma\ \textcolor{red}{\mathit{past}}\ \textcolor{blue}{\mathit{prophs}_1}
		\and
			\mathrm{proph \mathhyphen lb}\ \gamma\ \textcolor{teal}{\mathit{prophs}_2}
		}{
			\exists \textcolor{purple}{\mathit{past}_1}, \textcolor{orange}{\mathit{past}_2} .\,
			{\bigwedge\left[\begin{array}{rcl}
					\textcolor{red}{\mathit{past}} = \textcolor{purple}{\mathit{past}_1} \mdoubleplus & \textcolor{orange}{\mathit{past}_2} &
				\\
					& \textcolor{orange}{\mathit{past}_2} & \mdoubleplus\, \textcolor{blue}{\mathit{prophs}_1} = \textcolor{teal}{\mathit{prophs}_2}
			\end{array}\right.}
		}
\end{mathpar}
\end{frame}